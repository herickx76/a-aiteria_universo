<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carregando Loja...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ================= ESTILOS (CSS) ================= */
        :root {
            --primary: #4b0082; /* Cor padr√£o, ser√° sobrescrita se quiser */
            --primary-light: #6a0dad;
            --bg: #f4f4f9;
            --white: #ffffff;
            --text: #333;
            --gray: #888;
            --success: #25d366;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* Header */
        header { background: var(--primary); color: var(--white); padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { display: flex; align-items: center; gap: 15px; }
        .profile-pic img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .contact-info h3 { font-size: 1.1rem; margin-bottom: 2px; }
        .verified { color: #00bfff; font-size: 0.9rem; }
        #header-status { font-size: 0.8rem; opacity: 0.9; }

        /* Abas */
        .nav-tabs { display: flex; margin-top: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 3px; }
        .tab-btn { flex: 1; border: none; background: none; color: rgba(255,255,255,0.7); padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--white); color: var(--primary); }

        /* Layout & Sections */
        .main-container { max-width: 600px; margin: 0 auto; overflow: hidden; }
        .section-content { display: none; animation: fadeIn 0.3s; }
        .active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Slider Step Logic */
        .slider-container { display: flex; width: 200%; transition: transform 0.4s ease; }
        .slide-page { width: 50%; padding: 15px; }
        .show-step-1 { transform: translateX(0%); }
        .show-step-2 { transform: translateX(-50%); }

        /* Card√°pio Grid */
        .category-block { margin-bottom: 25px; }
        .cat-title { color: var(--primary); border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px; }
        .size-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .size-card { background: var(--white); border-radius: 12px; padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .size-card:active { transform: scale(0.98); }
        .card-img img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 10px; }
        .card-info .label { display: block; font-weight: bold; margin-bottom: 5px; }
        .card-info .price { color: var(--success); font-weight: bold; }

        /* Step 2: Customization */
        .back-header { cursor: pointer; color: var(--primary); font-weight: bold; margin-bottom: 15px; display: inline-block; }
        .product-header { background: var(--primary-light); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .menu-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .badge-required { background: #ff4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }
        .badge-free { background: var(--success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* List Items */
        .option-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .option-info { display: flex; align-items: center; gap: 10px; }
        .option-thumb { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; }
        .stepper { display: flex; align-items: center; gap: 10px; }
        .step-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--primary); background: white; color: var(--primary); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .selected-item { background-color: #f9f0ff; }
        .disabled { opacity: 0.4; pointer-events: none; }
        .hidden { display: none !important; }

        /* Inputs */
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 5px; font-size: 1rem; }

        /* Footer Cart */
        .menu-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 999; }
        .btn-finish { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .total-info { display: flex; flex-direction: column; }
        .total-info span { font-size: 1.2rem; font-weight: bold; color: var(--primary); }

        /* Chat */
        .chat-bg { height: calc(100vh - 180px); overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; width: 100%; }
        .msg-bot { justify-content: flex-start; }
        .msg-user { justify-content: flex-end; }
        .bubble { max-width: 80%; padding: 10px 15px; border-radius: 10px; position: relative; font-size: 0.95rem; }
        .msg-bot .bubble { background: white; border-top-left-radius: 0; }
        .msg-user .bubble { background: #dcf8c6; border-top-right-radius: 0; }
        .chat-input-area { position: fixed; bottom: 0; width: 100%; background: #f0f0f0; padding: 10px; display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        .btn-send-chat { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        
        /* Loading Overlay */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; z-index: 2000; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
        <p style="margin-top: 15px;">Carregando loja...</p>
    </div>

    <header id="main-header">
        <div class="header-content">
            <div class="profile-pic">
                <img id="logo-empresa" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/185/185983.png'">
            </div>
            <div class="contact-info">
                <h3 id="nome-empresa">Carregando...</h3>
                <p id="header-status"><i class="fas fa-circle" style="color: #0f0; font-size: 10px;"></i> Aberto agora</p>
            </div>
        </div>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="app.mudarAba('cardapio')" id="btn-cardapio">CARD√ÅPIO üìã</button>
            <button class="tab-btn" onclick="app.mudarAba('chat')" id="btn-chat">CHAT üí¨</button>
        </div>
    </header>

    <main class="main-container">
        
        <section id="view-cardapio" class="section-content active-section">
            <div class="slider-container show-step-1">
                
                <div class="slide-page" id="step-1-selection">
                    <div class="brand-banner" style="text-align: center; margin-bottom: 20px;">
                        <h2 class="menu-title">O que vamos pedir hoje? üòã</h2>
                    </div>

                    <div id="container-produtos"></div>
                </div>

                <div class="slide-page" id="step-2-customization">
                    <div class="back-header" onclick="app.voltarMenu()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </div>

                    <div class="product-header">
                        <h2 id="produto-nome" style="font-size: 1.2rem;">Produto</h2>
                        <span id="produto-base-price" style="font-weight: bold;">R$ 0,00</span>
                    </div>
                    
                    <form id="formPedido">
                        <div class="menu-card" id="card-sabores">
                            <div class="card-header">
                                1. Sabores <small id="txt-limite-sabor"></small>
                                <span class="badge-required">Obrigat√≥rio</span>
                            </div>
                            <div class="options-list" id="lista-sabores"></div>
                        </div>

                        <div class="menu-card" id="card-recheios">
                            <div class="card-header">
                                2. Recheios <small id="txt-limite-recheio"></small>
                                <span class="badge-free">Gr√°tis</span>
                            </div>
                            <div class="options-list" id="lista-recheios"></div>
                        </div>

                        <div class="menu-card" id="card-adicionais">
                            <div class="card-header">3. Adicionais Pagos</div>
                            <div class="options-list" id="lista-adicionais"></div>
                        </div>

                        <div class="menu-card">
                            <div class="card-header">üìù Seus Dados</div>
                            <input type="text" id="clienteNome" placeholder="Seu Nome" class="input-field">
                            <input type="tel" id="clienteZap" placeholder="Seu WhatsApp (com DDD)" class="input-field">
                            <textarea id="observacao" placeholder="Observa√ß√µes (opcional)" class="input-field" rows="2"></textarea>
                        </div>

                        <div style="height: 80px;"></div>
                    </form>
                </div>

            </div>
            
            <div class="menu-footer hidden" id="barra-pedido">
                <div class="total-info">
                    <small>Total:</small>
                    <span id="valorTotal">R$ 0,00</span>
                </div>
                <button class="btn-finish" onclick="app.enviarPedido()">
                    Enviar Pedido <i class="fab fa-whatsapp"></i>
                </button>
            </div>
        </section>

        <section id="view-chat" class="section-content hidden-section">
            <div class="chat-bg" id="chatWindow">
                <div class="msg msg-bot">
                    <div class="bubble">
                        Ol√°! Bem-vindo(a). üíú<br>
                        Como posso ajudar? (Pix, Endere√ßo, Entrega...)
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Digite sua d√∫vida..." onkeypress="if(event.key === 'Enter') app.enviarMsg()">
                <button class="btn-send-chat" onclick="app.enviarMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =========================================================
        // ‚ö†Ô∏è CONFIGURA√á√ÉO DA LOJA (MUDE AQUI PARA CADA CLIENTE) ‚ö†Ô∏è
        // =========================================================
        
        const ID_DA_LOJA = "joao_burguer";  // <-- MUDE AQUI PARA "maria_acai", ETC.

        // =========================================================

        const firebaseConfig = {
            apiKey: "AIzaSyBEY_lIGuxVfdm77D7MsBPYdNPQfmOJCkE",
            authDomain: "universodoacai-bfa78.firebaseapp.com",
            databaseURL: "https://universodoacai-bfa78-default-rtdb.firebaseio.com",
            projectId: "universodoacai-bfa78",
            storageBucket: "universodoacai-bfa78.firebasestorage.app",
            messagingSenderId: "945100141316",
            appId: "1:945100141316:web:b146319a68c0ed6986d651"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        class AppController {
            constructor() {
                this.empresaId = ID_DA_LOJA; // Pega da vari√°vel manual
                this.dadosEmpresa = {};
                this.produtoAtual = null;
                this.saboresDB = []; 
                this.recheiosDB = [];
                this.adicionaisDB = [];
            }

            async init() {
                console.log(`Iniciando sistema para a loja: ${this.empresaId}`);
                await this.carregarDadosEmpresa();
                await this.carregarOpcoesGlobais();
                document.getElementById('loading-screen').style.display = 'none';
            }

            async carregarDadosEmpresa() {
                try {
                    // Busca direto usando a vari√°vel ID_DA_LOJA
                    const docRef = doc(db, "empresas", this.empresaId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        this.dadosEmpresa = docSnap.data();
                        
                        document.title = this.dadosEmpresa.nome_fantasia;
                        document.getElementById('nome-empresa').innerText = this.dadosEmpresa.nome_fantasia;
                        
                        const cardapioArray = Object.entries(this.dadosEmpresa.cardapio || {}).map(([key, val]) => ({
                            id: key, ...val
                        }));
                        
                        this.renderizarCardapioPrincipal(cardapioArray);

                    } else {
                        document.getElementById('loading-screen').innerHTML = `
                            <h1>Loja n√£o encontrada</h1>
                            <p>ID procurado: ${this.empresaId}</p>
                            <p>Verifique a vari√°vel ID_DA_LOJA no c√≥digo.</p>
                        `;
                    }
                } catch (error) {
                    console.error("Erro ao carregar empresa:", error);
                    alert("Erro de conex√£o.");
                }
            }

            async carregarOpcoesGlobais() {
                // Carrega opcionais (sabores, recheios)
                // Se voc√™ tiver cole√ß√µes espec√≠ficas por empresa, mude aqui para buscar de "empresas/{id}/sabores"
                const getList = async (col) => {
                    const snap = await getDocs(collection(db, col));
                    const list = [];
                    snap.forEach(d => list.push({id: d.id, ...d.data()}));
                    return list;
                };
                
                this.saboresDB = await getList('sabores');
                this.recheiosDB = await getList('recheios');
                this.adicionaisDB = await getList('adicionais');

                // Fallback de dados falsos se o banco estiver vazio
                if(this.saboresDB.length === 0) {
                    this.saboresDB = [{nome: "Tradicional"}, {nome: "Morango"}, {nome: "Banana"}];
                    this.recheiosDB = [{nome: "Leite em p√≥"}, {nome: "Granola"}, {nome: "Pa√ßoca"}];
                }
            }

            renderizarCardapioPrincipal(itens) {
                const container = document.getElementById('container-produtos');
                let html = '<div class="category-block"><h3 class="cat-title">Destaques</h3><div class="size-grid">';

                if(itens.length === 0) html += '<p>Nenhum item no card√°pio ainda.</p>';

                itens.forEach(item => {
                    // Se o nome tiver "A√ßa√≠" ou "ml", abre menu de personaliza√ß√£o. Se n√£o, √© produto simples.
                    const isConfiguravel = item.nome.toLowerCase().includes('a√ßa√≠') || item.nome.toLowerCase().includes('ml') || item.nome.toLowerCase().includes('sorvete');
                    
                    html += `
                    <div class="size-card" onclick="app.abrirMontagem('${item.nome}', ${item.preco}, ${isConfiguravel})">
                        <div class="card-img"><img src="https://cdn-icons-png.flaticon.com/512/3081/3081967.png" alt="Item"></div>
                        <div class="card-info">
                            <span class="label">${item.nome}</span>
                            <span class="price">R$ ${item.preco.toFixed(2).replace('.',',')}</span>
                        </div>
                    </div>`;
                });

                html += '</div></div>';
                container.innerHTML = html;
            }

            abrirMontagem(nome, precoBase, configuravel) {
                this.produtoAtual = {
                    nome: nome,
                    base: precoBase,
                    configuravel: configuravel,
                    selecoes: { sabor: {}, recheio: {}, adicional: {} }
                };

                document.getElementById('produto-nome').innerText = nome;
                document.getElementById('produto-base-price').innerText = precoBase.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

                const displayStyle = configuravel ? 'block' : 'none';
                document.getElementById('card-sabores').style.display = displayStyle;
                document.getElementById('card-recheios').style.display = displayStyle;

                if (configuravel) {
                    this.renderizarListaOpcoes('sabor', this.saboresDB, 'lista-sabores');
                    this.renderizarListaOpcoes('recheio', this.recheiosDB, 'lista-recheios');
                }
                
                this.renderizarListaOpcoes('adicional', this.adicionaisDB, 'lista-adicionais');

                document.querySelector('.slider-container').classList.remove('show-step-1');
                document.querySelector('.slider-container').classList.add('show-step-2');
                document.getElementById('barra-pedido').classList.remove('hidden');
                
                this.calcularTotal();
            }

            voltarMenu() {
                document.querySelector('.slider-container').classList.remove('show-step-2');
                document.querySelector('.slider-container').classList.add('show-step-1');
                setTimeout(() => { document.getElementById('barra-pedido').classList.add('hidden'); }, 300);
            }

            renderizarListaOpcoes(tipo, dados, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = "";
                
                dados.forEach((item, index) => {
                    const precoTxt = item.preco ? `+ R$ ${item.preco.toFixed(2)}` : '';
                    const html = `
                    <div class="option-row" id="row-${tipo}-${index}">
                        <div class="option-info">
                            <div class="option-name">${item.nome} <small style="color:green">${precoTxt}</small></div>
                        </div>
                        <div class="stepper">
                            <button type="button" class="step-btn minus hidden" onclick="app.alterarQtd('${tipo}', ${index}, -1)">-</button>
                            <span class="step-count hidden" id="qtd-${tipo}-${index}">0</span>
                            <button type="button" class="step-btn plus" onclick="app.alterarQtd('${tipo}', ${index}, 1)">+</button>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            }

            alterarQtd(tipo, index, delta) {
                let listDB = (tipo === 'sabor') ? this.saboresDB : (tipo === 'recheio') ? this.recheiosDB : this.adicionaisDB;
                let item = listDB[index];
                
                let currentQtd = this.produtoAtual.selecoes[tipo][item.nome] || 0;
                let newQtd = currentQtd + delta;
                if (newQtd < 0) return;

                // Limites
                if (delta > 0 && tipo === 'sabor') {
                    let total = Object.values(this.produtoAtual.selecoes.sabor).reduce((a,b)=>a+b,0);
                    if (total >= 2) return alert("M√°ximo de 2 sabores!");
                }
                if (delta > 0 && tipo === 'recheio') {
                    let total = Object.values(this.produtoAtual.selecoes.recheio).reduce((a,b)=>a+b,0);
                    if (total >= 5) return alert("Limite de recheios atingido!");
                }

                if (newQtd === 0) delete this.produtoAtual.selecoes[tipo][item.nome];
                else this.produtoAtual.selecoes[tipo][item.nome] = newQtd;

                const elQtd = document.getElementById(`qtd-${tipo}-${index}`);
                const elMinus = document.querySelector(`#row-${tipo}-${index} .minus`);
                const elRow = document.getElementById(`row-${tipo}-${index}`);
                
                elQtd.innerText = newQtd;
                if (newQtd > 0) {
                    elQtd.classList.remove('hidden');
                    elMinus.classList.remove('hidden');
                    elRow.classList.add('selected-item');
                } else {
                    elQtd.classList.add('hidden');
                    elMinus.classList.add('hidden');
                    elRow.classList.remove('selected-item');
                }

                this.calcularTotal();
            }

            calcularTotal() {
                let total = this.produtoAtual.base;
                for (let [nome, qtd] of Object.entries(this.produtoAtual.selecoes.adicional)) {
                    let item = this.adicionaisDB.find(i => i.nome === nome);
                    if (item && item.preco) total += (item.preco * qtd);
                }
                document.getElementById('valorTotal').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                return total;
            }

            async enviarPedido() {
                const nome = document.getElementById('clienteNome').value;
                const zap = document.getElementById('clienteZap').value;
                const obs = document.getElementById('observacao').value;

                if (!nome || !zap) return alert("Preencha seu Nome e WhatsApp!");
                
                if (this.produtoAtual.configuravel) {
                    const qtdSabores = Object.keys(this.produtoAtual.selecoes.sabor).length;
                    if (qtdSabores === 0) return alert("Selecione pelo menos 1 sabor!");
                }

                const total = this.calcularTotal();

                const pedidoObj = {
                    cliente: nome,
                    telefone: zap,
                    produto: this.produtoAtual.nome,
                    total: total,
                    data: new Date().toISOString(),
                    status: 'pendente',
                    detalhes: this.produtoAtual.selecoes,
                    obs: obs
                };

                try {
                    // Salva na subcole√ß√£o correta da empresa configurada na vari√°vel
                    await addDoc(collection(db, "empresas", this.empresaId, "pedidos"), pedidoObj);
                    
                    let msg = `*NOVO PEDIDO - ${this.dadosEmpresa.nome_fantasia}*\n`;
                    msg += `üë§ Cliente: ${nome}\n`;
                    msg += `ü•£ Pedido: ${this.produtoAtual.nome}\n`;
                    
                    const listar = (obj, titulo) => {
                        let txt = "";
                        if(Object.keys(obj).length > 0) {
                            txt += `\n*${titulo}:*\n`;
                            for(let [k,v] of Object.entries(obj)) txt += `- ${v}x ${k}\n`;
                        }
                        return txt;
                    };

                    msg += listar(this.produtoAtual.selecoes.sabor, "Sabores");
                    msg += listar(this.produtoAtual.selecoes.recheio, "Recheios");
                    msg += listar(this.produtoAtual.selecoes.adicional, "Adicionais");
                    
                    if(obs) msg += `\nüìù Obs: ${obs}\n`;
                    msg += `\nüí∞ *Total: R$ ${total.toFixed(2)}*`;

                    const zapLoja = this.dadosEmpresa.telefone;
                    window.open(`https://wa.me/${zapLoja}?text=${encodeURIComponent(msg)}`, '_blank');
                    
                    location.reload();

                } catch (err) {
                    console.error(err);
                    alert("Erro ao salvar pedido.");
                }
            }

            mudarAba(aba) {
                const viewCardapio = document.getElementById('view-cardapio');
                const viewChat = document.getElementById('view-chat');
                const btnCardapio = document.getElementById('btn-cardapio');
                const btnChat = document.getElementById('btn-chat');

                if (aba === 'cardapio') {
                    viewCardapio.classList.add('active-section'); viewCardapio.classList.remove('hidden-section');
                    viewChat.classList.remove('active-section'); viewChat.classList.add('hidden-section');
                    btnCardapio.classList.add('active'); btnChat.classList.remove('active');
                } else {
                    viewCardapio.classList.remove('active-section'); viewCardapio.classList.add('hidden-section');
                    viewChat.classList.add('active-section'); viewChat.classList.remove('hidden-section');
                    btnCardapio.classList.remove('active'); btnChat.classList.add('active');
                }
            }

            enviarMsg() {
                const input = document.getElementById('chatInput');
                const txt = input.value.trim();
                if(!txt) return;

                const chatWin = document.getElementById('chatWindow');
                chatWin.insertAdjacentHTML('beforeend', `<div class="msg msg-user"><div class="bubble">${txt}</div></div>`);
                input.value = "";
                chatWin.scrollTop = chatWin.scrollHeight;

                setTimeout(() => {
                    let resp = "N√£o entendi, sou um rob√¥ b√°sico. Por favor, me chame no WhatsApp acima!";
                    const lower = txt.toLowerCase();
                    if(lower.includes('pix')) resp = "Nossa chave Pix √© o CNPJ ou Celular cadastrado!";
                    if(lower.includes('hora')) resp = "Estamos abertos agora!";
                    if(lower.includes('endere√ßo') || lower.includes('onde')) resp = "Veja nossa localiza√ß√£o no Google Maps.";

                    chatWin.insertAdjacentHTML('beforeend', `<div class="msg msg-bot"><div class="bubble">${resp}</div></div>`);
                    chatWin.scrollTop = chatWin.scrollHeight;
                }, 800);
            }
        }

        const app = new AppController();
        window.app = app; 
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>