<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carregando Loja...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ================= ESTILOS (Design) ================= */
        :root {
            --primary: #4b0082;
            --primary-light: #6a0dad;
            --bg: #f4f4f9;
            --white: #ffffff;
            --text: #333;
            --success: #25d366;
            --danger: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* Header */
        header { background: var(--primary); color: var(--white); padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { display: flex; align-items: center; justify-content: center; gap: 15px; text-align: left; }
        .profile-pic img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .contact-info h3 { font-size: 1.2rem; margin-bottom: 2px; }
        #header-status { font-size: 0.8rem; opacity: 0.9; }

        /* Layout Slider (4 Telas) */
        .main-container { max-width: 600px; margin: 0 auto; overflow: hidden; padding-top: 20px; }
        .slider-container { display: flex; width: 400%; transition: transform 0.4s ease; } 
        .slide-page { width: 25%; padding: 15px; } 
        
        .show-step-1 { transform: translateX(0%); }      /* Menu */
        .show-step-2 { transform: translateX(-25%); }    /* Montagem */
        .show-step-3 { transform: translateX(-50%); }    /* Checkout */
        .show-step-4 { transform: translateX(-75%); }    /* Sucesso */

        /* SE√á√ïES E GRID DE PRODUTOS */
        .section-block { margin-bottom: 30px; }
        .section-title { 
            color: var(--primary); 
            font-size: 1.3rem; 
            font-weight: 800;
            border-left: 5px solid var(--success);
            padding-left: 10px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .size-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .size-card { background: var(--white); border-radius: 12px; padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .size-card:active { transform: scale(0.98); }
        .card-img img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
        .card-info .label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
        .card-info .price { color: var(--success); font-weight: bold; }

        /* Tela de Montagem */
        .back-header { cursor: pointer; color: var(--primary); font-weight: bold; margin-bottom: 15px; display: inline-block; padding: 5px 10px; background: rgba(0,0,0,0.05); border-radius: 20px; }
        .product-header { background: var(--primary-light); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .menu-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* Op√ß√µes (Sabores/Recheios) */
        .option-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
        .option-info { display: flex; align-items: center; gap: 12px; }
        .option-thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; background-color: #f9f9f9; }
        .option-name { font-weight: 500; font-size: 0.95rem; }
        .stepper { display: flex; align-items: center; gap: 10px; }
        .step-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--primary); background: white; color: var(--primary); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .selected-item { background-color: #fcfaff; }
        
        .hidden { display: none !important; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }
        .input-label { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 5px; display: block; }

        /* Barra Inferior */
        .menu-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px 20px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 999; }
        .btn-action { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .btn-cart-view { background: var(--primary); width: 100%; justify-content: space-between; }
        .total-info { display: flex; flex-direction: column; }
        .total-info small { color: #666; font-size: 0.8rem; }
        .total-info span { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

        /* Carrinho */
        .cart-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #fff; position: relative; }
        .cart-item-title { font-weight: bold; color: var(--primary); }
        .cart-item-desc { font-size: 0.85rem; color: #666; margin: 5px 0; }
        .cart-item-price { font-weight: bold; color: var(--success); }
        .btn-remove { position: absolute; top: 10px; right: 10px; color: var(--danger); cursor: pointer; background: none; border: none; font-size: 1.1rem; }
        select.input-field { background: white; }

        /* Tela Sucesso */
        .success-box { text-align: center; margin-top: 50px; }
        .success-icon { color: var(--success); font-size: 5rem; margin-bottom: 20px; }

        /* ======================================================== */
        /* ANIMA√á√ÉO DE ADICIONAR AO CARRINHO (PROFISSIONAL) */
        /* ======================================================== */
        #overlay-animacao {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px); /* Efeito Blur */
            z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #overlay-animacao.ativo { opacity: 1; pointer-events: all; }

        .animacao-icone {
            font-size: 6rem;
            color: var(--primary);
            opacity: 0;
            transform: translateX(-150px) scale(0.5); /* Come√ßa na esquerda pequeno */
        }

        /* Classe que dispara o movimento */
        .disparar-fly {
            animation: fly-into-cart 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        @keyframes fly-into-cart {
            0% {
                opacity: 0;
                transform: translateX(-100vw) scale(0.5); /* Fora da tela esquerda */
            }
            40% {
                opacity: 1;
                transform: translateX(0) scale(1.3); /* Meio da tela GRANDE */
            }
            60% {
                opacity: 1;
                transform: translateX(0) scale(1.0); /* Meio da tela Normal */
            }
            100% {
                opacity: 0;
                transform: translateX(100vw) scale(0.5); /* Sai pela direita */
            }
        }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; z-index: 2000; }
    </style>
</head>
<body>

    <div id="overlay-animacao">
        <i class="fas fa-cart-plus animacao-icone" id="icone-animado"></i>
    </div>

    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
        <p style="margin-top: 15px; font-weight: bold;" id="loading-text">Carregando Loja...</p>
    </div>

    <header id="main-header">
        <div class="header-content">
            <div class="profile-pic">
                <img id="logo-empresa" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/185/185983.png'">
            </div>
            <div class="contact-info">
                <h3 id="nome-empresa">...</h3>
                <p id="header-status"><i class="fas fa-circle" style="color: #00ff00; font-size: 8px;"></i> Aberto</p>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="slider-container show-step-1">
            
            <div class="slide-page" id="step-1-selection">
                <div class="brand-banner" style="text-align: center; margin-bottom: 25px;">
                    <h2 style="color: var(--primary);">Card√°pio Digital üíú</h2>
                </div>
                <div id="container-produtos"></div>
                <div style="height: 60px;"></div>
            </div>

            <div class="slide-page" id="step-2-customization">
                <div class="back-header" onclick="app.voltarMenu()">
                    <i class="fas fa-chevron-left"></i> Voltar
                </div>

                <div class="product-header">
                    <h2 id="produto-nome" style="font-size: 1.1rem;">Produto</h2>
                    <span id="produto-base-price" style="font-weight: bold;">R$ 0,00</span>
                </div>
                
                <form id="formPedido">
                    <div class="menu-card" id="card-sabores">
                        <div class="card-header">1. Sabores <small>(At√© 2)</small></div>
                        <div class="options-list" id="lista-sabores"></div>
                    </div>

                    <div class="menu-card" id="card-recheios">
                        <div class="card-header">2. Recheios <small>(Gr√°tis)</small></div>
                        <div class="options-list" id="lista-recheios"></div>
                    </div>

                    <div class="menu-card" id="card-adicionais">
                        <div class="card-header">3. Adicionais Pagos</div>
                        <div class="options-list" id="lista-adicionais"></div>
                    </div>
                    
                    <div class="menu-card">
                         <div class="card-header">üìù Observa√ß√£o do Item</div>
                         <textarea id="obs-item" placeholder="Ex: Sem calda, capricha no leite em p√≥..." class="input-field" rows="2"></textarea>
                    </div>

                    <div style="height: 100px;"></div>
                </form>
            </div>

            <div class="slide-page" id="step-3-checkout">
                <div class="back-header" onclick="app.voltarMenu()">
                    <i class="fas fa-chevron-left"></i> Voltar ao Menu
                </div>

                <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Seu Carrinho</h2>
                
                <div id="lista-itens-carrinho"></div>

                <h2 class="section-title" style="margin-top: 20px;"><i class="fas fa-map-marker-alt"></i> Entrega</h2>
                <div class="menu-card">
                    <label class="input-label">Rua / Logradouro</label>
                    <input type="text" id="end-rua" class="input-field" placeholder="Ex: Av. Principal">
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label class="input-label">N√∫mero</label>
                            <input type="text" id="end-num" class="input-field" placeholder="123">
                        </div>
                        <div style="flex: 2;">
                            <label class="input-label">Bairro</label>
                            <input type="text" id="end-bairro" class="input-field" placeholder="Centro">
                        </div>
                    </div>

                    <label class="input-label">Ponto de Refer√™ncia</label>
                    <input type="text" id="end-ref" class="input-field" placeholder="Ex: Pr√≥ximo ao mercado...">
                </div>

                <h2 class="section-title"><i class="fas fa-user"></i> Seus Dados</h2>
                <div class="menu-card">
                    <label class="input-label">Seu Nome</label>
                    <input type="text" id="clienteNome" placeholder="Jo√£o Silva" class="input-field">
                    
                    <label class="input-label">Seu WhatsApp</label>
                    <input type="tel" id="clienteZap" placeholder="(11) 99999-9999" class="input-field">
                </div>

                <h2 class="section-title"><i class="fas fa-wallet"></i> Pagamento</h2>
                <div class="menu-card">
                    <label class="input-label">Forma de Pagamento</label>
                    <select id="forma-pagamento" class="input-field" onchange="app.verificarTroco(this)">
                        <option value="Pix">Pix (Chave CPF/CNPJ)</option>
                        <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                        <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                        <option value="Dinheiro">Dinheiro</option>
                    </select>

                    <div id="campo-troco" class="hidden">
                        <label class="input-label">Troco para quanto?</label>
                        <input type="text" id="valor-troco" class="input-field" placeholder="Ex: 50,00">
                    </div>
                </div>

                <div style="height: 100px;"></div>
            </div>

            <div class="slide-page" id="step-4-success">
                <div class="success-box">
                    <i class="fas fa-check-circle success-icon"></i>
                    <h2 style="color: var(--primary); margin-bottom: 10px;">Pedido Recebido!</h2>
                    <p style="color: #666; font-size: 1.1rem;">Seu pedido j√° chegou na nossa cozinha.</p>
                    <p style="margin-top: 20px; font-weight: bold;">Obrigado pela prefer√™ncia!</p>

                    <button class="btn-action" onclick="location.reload()" style="margin: 30px auto; background: var(--primary);">
                        Fazer Novo Pedido
                    </button>
                </div>
            </div>

        </div>
        
        <div class="menu-footer hidden" id="barra-adicionar">
            <div class="total-info">
                <small>Total do Item:</small>
                <span id="valorTotalItem">R$ 0,00</span>
            </div>
            <button class="btn-action" onclick="app.adicionarAoCarrinho()">
                Adicionar <i class="fas fa-plus"></i>
            </button>
        </div>

        <div class="menu-footer hidden" id="barra-ver-carrinho" style="background: transparent; box-shadow: none; pointer-events: none;">
            <button class="btn-action btn-cart-view" onclick="app.abrirCheckout()" style="pointer-events: all; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <span><i class="fas fa-shopping-bag"></i> Ver Carrinho (<span id="count-carrinho">0</span>)</span>
                <span id="total-carrinho-float">R$ 0,00</span>
            </button>
        </div>

        <div class="menu-footer hidden" id="barra-finalizar">
            <div class="total-info">
                <small>Total Final:</small>
                <span id="valorTotalFinal">R$ 0,00</span>
            </div>
            <button class="btn-action" onclick="app.finalizarPedidoNoBanco()" style="background: #25d366;">
                Finalizar Pedido <i class="fas fa-check"></i>
            </button>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, child, get, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // =========================================================
        // CONFIGURA√á√ÉO
        // =========================================================
        const ID_DA_LOJA = "universo_acai"; 
        const firebaseConfig = {
            apiKey: "AIzaSyCikTxSJLoSBJeGrNRugs1MvWxCohakwnI",
            authDomain: "database-anotador.firebaseapp.com",
            databaseURL: "https://database-anotador-default-rtdb.firebaseio.com",
            projectId: "database-anotador",
            storageBucket: "database-anotador.firebasestorage.app",
            messagingSenderId: "1026172295848",
            appId: "1:1026172295848:web:b5193909feee24ac8d409d"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getDatabase(appFirebase);

        class AppController {
            constructor() {
                this.empresaId = ID_DA_LOJA;
                this.dadosEmpresa = {};
                this.carrinho = [];
                this.produtoAtual = null;
                this.saboresDB = []; 
                this.recheiosDB = [];
                this.adicionaisDB = [];
            }

            async init() {
                try {
                    await this.carregarDadosEmpresa();
                    await this.carregarOpcoesGlobais();
                    const salvo = localStorage.getItem('meuCarrinhoAcai');
                    if(salvo) {
                        this.carrinho = JSON.parse(salvo);
                        this.atualizarBarraFlutuante();
                    }
                } catch (e) {
                    console.error("Erro:", e);
                }
                document.getElementById('loading-screen').style.display = 'none';
            }

            async carregarDadosEmpresa() {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, `empresas/${this.empresaId}`));
                if (snapshot.exists()) {
                    this.dadosEmpresa = snapshot.val();
                    document.title = this.dadosEmpresa.nome_fantasia;
                    document.getElementById('nome-empresa').innerText = this.dadosEmpresa.nome_fantasia;
                    if (this.dadosEmpresa.logo) document.getElementById('logo-empresa').src = `imagens/${this.dadosEmpresa.logo}`;
                    this.renderizarCardapioSegmentado(this.dadosEmpresa.cardapio || {});
                } else {
                    alert("Loja n√£o encontrada.");
                }
            }

            async carregarOpcoesGlobais() {
                const dbRef = ref(db);
                const fetchList = async (path) => {
                    const snap = await get(child(dbRef, path));
                    return snap.exists() ? Object.values(snap.val()) : [];
                };
                this.saboresDB = await fetchList('sabores_acai');
                this.recheiosDB = await fetchList('recheios_acai');
                this.adicionaisDB = await fetchList('adds_acai');
            }

            renderizarCardapioSegmentado(cardapioObj) {
                const container = document.getElementById('container-produtos');
                container.innerHTML = "";
                if (Object.keys(cardapioObj).length === 0) {
                    container.innerHTML = "<p>Card√°pio vazio.</p>";
                    return;
                }
                Object.entries(cardapioObj).forEach(([chaveSecao, dadosSecao]) => {
                    let htmlSecao = `
                    <div class="section-block">
                        <h3 class="section-title">${dadosSecao.titulo}</h3>
                        <div class="size-grid">`;
                    if(dadosSecao.itens) {
                        Object.entries(dadosSecao.itens).forEach(([chaveItem, item]) => {
                            const nome = item.nome.toLowerCase();
                            const isConfiguravel = nome.includes('isopor') || nome.includes('copo') || nome.includes('a√ßa√≠') || nome.includes('tigela') || nome.includes('barca') || nome.includes('ml') || nome.includes('litro');
                            let imgPath = item.imagem ? item.imagem : 'https://cdn-icons-png.flaticon.com/512/3081/3081967.png';
                            htmlSecao += `
                            <div class="size-card" onclick="app.abrirMontagem('${item.nome}', ${item.preco}, ${isConfiguravel})">
                                <div class="card-img">
                                    <img src="${imgPath}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3081/3081967.png'">
                                </div>
                                <div class="card-info">
                                    <span class="label">${item.nome}</span>
                                    <span class="price">R$ ${item.preco.toFixed(2).replace('.',',')}</span>
                                </div>
                            </div>`;
                        });
                    }
                    htmlSecao += `</div></div>`;
                    container.innerHTML += htmlSecao;
                });
            }

            voltarMenu() {
                document.querySelector('.slider-container').className = 'slider-container show-step-1';
                document.getElementById('barra-adicionar').classList.add('hidden');
                document.getElementById('barra-finalizar').classList.add('hidden');
                this.atualizarBarraFlutuante(); 
                window.scrollTo(0,0);
            }

            abrirCheckout() {
                if(this.carrinho.length === 0) return alert("Seu carrinho est√° vazio!");
                this.renderizarCarrinho();
                document.querySelector('.slider-container').className = 'slider-container show-step-3';
                document.getElementById('barra-ver-carrinho').classList.add('hidden');
                document.getElementById('barra-finalizar').classList.remove('hidden');
                window.scrollTo(0,0);
            }
            
            abrirMontagem(nome, precoBase, configuravel) {
                this.produtoAtual = {
                    idTemp: Date.now(),
                    nome: nome, 
                    base: precoBase, 
                    configuravel: configuravel,
                    selecoes: { sabor: {}, recheio: {}, adicional: {} },
                    obs: ""
                };
                document.getElementById('produto-nome').innerText = nome;
                document.getElementById('produto-base-price').innerText = precoBase.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('obs-item').value = ""; 

                const displayStyle = configuravel ? 'block' : 'none';
                document.getElementById('card-sabores').style.display = displayStyle;
                document.getElementById('card-recheios').style.display = displayStyle;

                if (configuravel) {
                    this.renderizarListaOpcoes('sabor', this.saboresDB, 'lista-sabores');
                    this.renderizarListaOpcoes('recheio', this.recheiosDB, 'lista-recheios');
                }
                this.renderizarListaOpcoes('adicional', this.adicionaisDB, 'lista-adicionais');

                document.querySelector('.slider-container').className = 'slider-container show-step-2';
                document.getElementById('barra-ver-carrinho').classList.add('hidden');
                document.getElementById('barra-adicionar').classList.remove('hidden');
                window.scrollTo(0,0);
                this.calcularTotalItem();
            }

            renderizarListaOpcoes(tipo, dados, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = "";
                if(!dados || dados.length === 0) {
                    container.innerHTML = "<small style='display:block; padding:10px; color:#999'>Sem op√ß√µes.</small>";
                    return;
                }
                const imgPlaceholder = 'https://cdn-icons-png.flaticon.com/512/1375/1375106.png';
                dados.forEach((item, index) => {
                    const precoTxt = item.preco ? `+ R$ ${item.preco.toFixed(2)}` : '';
                    const imgSource = item.imagem ? item.imagem : imgPlaceholder;
                    container.innerHTML += `
                    <div class="option-row" id="row-${tipo}-${index}">
                        <div class="option-info">
                            <img src="${imgSource}" class="option-thumb" onerror="this.src='${imgPlaceholder}'">
                            <div class="option-name">
                                ${item.nome} 
                                <small style="color:green; font-weight:bold; display:block; font-size:0.8rem">${precoTxt}</small>
                            </div>
                        </div>
                        <div class="stepper">
                            <button type="button" class="step-btn minus hidden" onclick="app.alterarQtd('${tipo}', ${index}, -1)">-</button>
                            <span class="step-count hidden" id="qtd-${tipo}-${index}">0</span>
                            <button type="button" class="step-btn plus" onclick="app.alterarQtd('${tipo}', ${index}, 1)">+</button>
                        </div>
                    </div>`;
                });
            }

            alterarQtd(tipo, index, delta) {
                let listDB = (tipo === 'sabor') ? this.saboresDB : (tipo === 'recheio') ? this.recheiosDB : this.adicionaisDB;
                let item = listDB[index];
                
                let currentQtd = this.produtoAtual.selecoes[tipo][item.nome] || 0;
                let newQtd = currentQtd + delta;
                if (newQtd < 0) return;

                if (delta > 0 && tipo === 'sabor') {
                    const total = Object.values(this.produtoAtual.selecoes.sabor).reduce((a,b)=>a+b,0);
                    if (total >= 2) return alert("M√°ximo de 2 sabores!");
                }
                if (delta > 0 && tipo === 'recheio') {
                    const total = Object.values(this.produtoAtual.selecoes.recheio).reduce((a,b)=>a+b,0);
                    if (total >= 5) return alert("Limite de recheios atingido.");
                }

                if (newQtd === 0) delete this.produtoAtual.selecoes[tipo][item.nome];
                else this.produtoAtual.selecoes[tipo][item.nome] = newQtd;

                const elQtd = document.getElementById(`qtd-${tipo}-${index}`);
                const elMinus = document.querySelector(`#row-${tipo}-${index} .minus`);
                const elRow = document.getElementById(`row-${tipo}-${index}`);
                
                elQtd.innerText = newQtd;
                if(newQtd > 0) {
                    elQtd.classList.remove('hidden'); elMinus.classList.remove('hidden'); elRow.classList.add('selected-item');
                } else {
                    elQtd.classList.add('hidden'); elMinus.classList.add('hidden'); elRow.classList.remove('selected-item');
                }
                this.calcularTotalItem();
            }

            calcularTotalItem() {
                let total = this.produtoAtual.base;
                for (let [nome, qtd] of Object.entries(this.produtoAtual.selecoes.adicional)) {
                    let item = this.adicionaisDB.find(i => i.nome === nome);
                    if (item && item.preco) total += (item.preco * qtd);
                }
                this.produtoAtual.totalCalculado = total;
                document.getElementById('valorTotalItem').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                return total;
            }

            adicionarAoCarrinho() {
                if (this.produtoAtual.configuravel && Object.keys(this.produtoAtual.selecoes.sabor).length === 0) {
                    return alert("Escolha ao menos 1 Sabor!");
                }
                this.produtoAtual.obs = document.getElementById('obs-item').value.trim();
                this.carrinho.push(this.produtoAtual);
                localStorage.setItem('meuCarrinhoAcai', JSON.stringify(this.carrinho));

                // CHAMA A ANIMA√á√ÉO PROFISSIONAL AQUI
                this.tocarAnimacaoAdicao();
            }

            tocarAnimacaoAdicao() {
                const overlay = document.getElementById('overlay-animacao');
                const icone = document.getElementById('icone-animado');

                // 1. Mostra o fundo borrado
                overlay.classList.add('ativo');

                // 2. Dispara a anima√ß√£o do √≠cone
                icone.classList.remove('disparar-fly'); // Reseta
                void icone.offsetWidth; // For√ßa reflow (reiniciar anima√ß√£o)
                icone.classList.add('disparar-fly');

                // 3. Quando acabar a anima√ß√£o (1.5s), volta pro menu
                setTimeout(() => {
                    overlay.classList.remove('ativo');
                    this.voltarMenu();
                }, 1500);
            }

            atualizarBarraFlutuante() {
                const count = this.carrinho.length;
                if (count > 0) {
                    let total = this.carrinho.reduce((acc, item) => acc + item.totalCalculado, 0);
                    document.getElementById('count-carrinho').innerText = count;
                    document.getElementById('total-carrinho-float').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                    document.getElementById('barra-ver-carrinho').classList.remove('hidden');
                } else {
                    document.getElementById('barra-ver-carrinho').classList.add('hidden');
                }
            }

            renderizarCarrinho() {
                const container = document.getElementById('lista-itens-carrinho');
                container.innerHTML = "";
                let totalGeral = 0;
                this.carrinho.forEach((item, index) => {
                    totalGeral += item.totalCalculado;
                    let desc = [];
                    if(item.selecoes) {
                        for(let k in item.selecoes.sabor) desc.push(`${item.selecoes.sabor[k]}x ${k}`);
                        for(let k in item.selecoes.recheio) desc.push(`+ ${k}`);
                        for(let k in item.selecoes.adicional) desc.push(`+ ${k}`);
                    }
                    if(item.obs) desc.push(`Obs: ${item.obs}`);
                    container.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-title">${item.nome}</div>
                        <div class="cart-item-desc">${desc.join(', ')}</div>
                        <div class="cart-item-price">R$ ${item.totalCalculado.toFixed(2).replace('.',',')}</div>
                        <button class="btn-remove" onclick="app.removerDoCarrinho(${index})"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                document.getElementById('valorTotalFinal').innerText = totalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            }

            removerDoCarrinho(index) {
                if(confirm("Remover este item?")) {
                    this.carrinho.splice(index, 1);
                    localStorage.setItem('meuCarrinhoAcai', JSON.stringify(this.carrinho));
                    if(this.carrinho.length === 0) this.voltarMenu();
                    else this.renderizarCarrinho();
                }
            }

            verificarTroco(select) {
                const div = document.getElementById('campo-troco');
                if(select.value === 'Dinheiro') div.classList.remove('hidden');
                else div.classList.add('hidden');
            }

            async finalizarPedidoNoBanco() {
                const rua = document.getElementById('end-rua').value.trim();
                const bairro = document.getElementById('end-bairro').value.trim();
                const num = document.getElementById('end-num').value.trim();
                const refEnd = document.getElementById('end-ref').value.trim();
                const nome = document.getElementById('clienteNome').value.trim();
                const zap = document.getElementById('clienteZap').value.trim();
                const pag = document.getElementById('forma-pagamento').value;
                const troco = document.getElementById('valor-troco').value.trim();

                if(!rua || !bairro || !num || !nome || zap.length < 8) return alert("Preencha o Endere√ßo completo, Nome e WhatsApp.");
                if(pag === 'Dinheiro' && !troco) return alert("Informe o valor para troco.");

                let totalGeral = this.carrinho.reduce((acc, item) => acc + item.totalCalculado, 0);
                const itensLimpos = this.carrinho.map(i => ({
                    produto: i.nome,
                    total: i.totalCalculado,
                    obs: i.obs,
                    sabores: i.selecoes.sabor,
                    recheios: i.selecoes.recheio,
                    adicionais: i.selecoes.adicional
                }));

                const pedidoObj = {
                    cliente: { nome: nome, whatsapp: zap },
                    endereco: { rua: rua, numero: num, bairro: bairro, referencia: refEnd },
                    pagamento: { metodo: pag, troco_para: troco || "N/A" },
                    itens: itensLimpos,
                    total_pedido: totalGeral,
                    status: 'pendente',
                    data_hora: new Date().toLocaleString('pt-BR')
                };

                document.getElementById('loading-text').innerText = "Enviando Pedido...";
                document.getElementById('loading-screen').style.display = 'flex';

                try {
                    const path = `empresas/${this.empresaId}/pedidos`;
                    await push(ref(db, path), pedidoObj);
                    localStorage.removeItem('meuCarrinhoAcai');
                    this.carrinho = [];
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('barra-finalizar').classList.add('hidden');
                    document.querySelector('.slider-container').className = 'slider-container show-step-4'; 
                } catch (err) {
                    console.error(err);
                    document.getElementById('loading-screen').style.display = 'none';
                    alert("Erro ao enviar pedido.");
                }
            }
        }

        const app = new AppController();
        window.app = app;
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>